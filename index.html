<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國文科即時測驗系統 Pro (雲端同步終極版)</title>
    
    <!-- 基礎環境 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #020617; 
            color: #f8fafc; 
            margin: 0; 
        }
        
        @media print {
            @page { size: A4; margin: 0.8cm; }
            .no-print { display: none !important; }
            body { background-color: white !important; color: black !important; }
            .print-container { background-color: white !important; padding: 0 !important; margin: 0 !important; }
            .print-card {
                border: 1px solid #ddd !important;
                margin-bottom: 12px !important;
                padding: 15px !important;
                page-break-inside: avoid;
                border-radius: 8px !important;
            }
            .print-title { font-size: 16pt !important; font-weight: bold !important; margin-bottom: 10px; }
            .print-text { font-size: 12pt !important; line-height: 1.5 !important; }
            .print-explanation { 
                font-size: 12pt !important; 
                background: #f4f4f5 !important; 
                padding: 12px !important; 
                margin-top: 12px !important;
                border-left: 5px solid #f59e0b !important;
                color: #18181b !important;
            }
        }
        
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 教師核心設定區 ---
        // 1. 您的 GAS URL (用於記錄成績與發信)
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbybMG3mL2OgqX_i0ZeRexPy619ErLP_S9EjdLJbUw2-FjCFuJy2xqxzhPVlzuZ9wWUQdg/exec"; 
        
        // 2. 您的 Google 試算表發佈網址 (已更新為您的連結)
        const CLOUD_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeeTPV9EYTlaOLrCNmA6UvRJOtpshFIMHCfp11JwNwvFnAYc5v73_ytLM3MSQUsfNpxOmsfZucPeZZ/pub?output=csv"; 
        
        const ADMIN_PASS = "153154";
        const LOCAL_CSV_FALLBACK = "./test.csv"; 
        // --------------------

        const { useState, useEffect, useCallback, useRef } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            const render = useCallback(() => {
                if (window.lucide && window.lucide.icons[name]) {
                    const svg = window.lucide.icons[name].toSvg({ width: size, height: size, class: className });
                    if (iconRef.current) iconRef.current.innerHTML = svg;
                }
            }, [name, size, className]);
            useEffect(() => { render(); }, [render]);
            return <span ref={iconRef} className="inline-flex items-center justify-center"></span>;
        };

        const IMEInput = ({ value, onChange, placeholder, className, type = "text" }) => {
            const [localValue, setLocalValue] = useState(value);
            const isComposing = useRef(false);
            const lastExternalValue = useRef(value);

            useEffect(() => { 
                if (!isComposing.current && value !== lastExternalValue.current) {
                    setLocalValue(value);
                    lastExternalValue.current = value;
                }
            }, [value]);

            const handleCompositionStart = () => { isComposing.current = true; };
            const handleCompositionEnd = (e) => {
                isComposing.current = false;
                setLocalValue(e.target.value);
                lastExternalValue.current = e.target.value;
                onChange(e.target.value);
            };
            const handleChange = (e) => {
                setLocalValue(e.target.value);
                if (!isComposing.current) {
                    lastExternalValue.current = e.target.value;
                    onChange(e.target.value);
                }
            };

            return (
                <input type={type} value={localValue} placeholder={placeholder} className={className}
                    onChange={handleChange} onCompositionStart={handleCompositionStart} onCompositionEnd={handleCompositionEnd} autoComplete="off" />
            );
        };

        const App = () => {
            const [view, setView] = useState('login');
            const [studentInfo, setStudentInfo] = useState({ class: '', seat: '', name: '', email: '' });
            const [quizData, setQuizData] = useState([]);
            const [quizName, setQuizName] = useState('資料同步中...');
            const [answers, setAnswers] = useState({});
            const [results, setResults] = useState(null);
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [emailStatus, setEmailStatus] = useState('');

            // 智慧型題目與選項拆解引擎
            const processQuestionText = (rawText) => {
                const optRegex = /[\(\（][A-D]|[Ａ-Ｄ][\)\）]/g;
                const parts = rawText.split(optRegex);
                if (parts && parts.length >= 5) {
                    return {
                        stem: parts[0].trim(),
                        options: {
                            'A': parts[1].trim(), 'B': parts[2].trim(), 'C': parts[3].trim(), 'D': parts[4].trim()
                        },
                        isParsed: true
                    };
                }
                return { stem: rawText, options: null, isParsed: false };
            };

            const parseCSV = (text) => {
                const rows = text.split(/\r?\n/).filter(line => line.trim() !== "");
                const delimiter = text.includes('\t') ? '\t' : ',';
                
                const data = rows.slice(1).map(row => {
                    const columns = row.split(delimiter).map(col => col.replace(/^"|"$/g, '').trim());
                    const rawQuestion = columns[0] || "";
                    const parsed = processQuestionText(rawQuestion);
                    return {
                        ...parsed,
                        answer: (columns[1] || "").toUpperCase().replace(/[ＡＢＣＤ]/g, s => String.fromCharCode(s.charCodeAt(0) - 65248)),
                        explanation: columns[2] || ""
                    };
                }).filter(item => item.stem && item.answer);
                setQuizData(data);
            };

            useEffect(() => {
                const targetUrl = CLOUD_CSV_URL || LOCAL_CSV_FALLBACK;
                fetch(targetUrl)
                    .then(res => res.text())
                    .then(text => {
                        parseCSV(text);
                        setQuizName(CLOUD_CSV_URL ? "已連結雲端題庫" : "使用本地備援題庫");
                    })
                    .catch(() => {
                        setQuizName("尚未配置有效題庫");
                    });
            }, []);

            const handleSubmitQuiz = async () => {
                const scorePerQuestion = 100 / quizData.length;
                let correctCount = 0;
                const detailResults = quizData.map((q, idx) => {
                    const studentAnswer = answers[idx] || '未答';
                    const isCorrect = studentAnswer === q.answer;
                    if (isCorrect) correctCount++;
                    return { ...q, studentAnswer, isCorrect };
                });

                // 統計錯誤題號 (1-indexed)
                const wrongIndices = detailResults
                    .map((d, i) => d.isCorrect ? null : i + 1)
                    .filter(n => n !== null)
                    .join(', ');

                const finalScore = Math.round(correctCount * scorePerQuestion);
                const report = {
                    score: finalScore,
                    date: new Date().toLocaleString('zh-TW'),
                    details: detailResults,
                    wrongQuestions: wrongIndices || "全對"
                };
                
                setResults(report);
                setView('results');

                // 回傳 GAS：包含班級、座號、姓名、成績、錯誤題號
                if (GAS_WEB_APP_URL) {
                    fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({ 
                            ...studentInfo, 
                            score: report.score,
                            date: report.date,
                            wrongQuestions: report.wrongQuestions,
                            action: 'logScore' 
                        })
                    });
                }
            };

            const sendRealEmail = async () => {
                if (!studentInfo.email.includes('@')) return alert('信箱格式有誤');
                setEmailStatus('正在發送...');
                try {
                    await fetch(GAS_WEB_APP_URL, {
                        method: 'POST', mode: 'no-cors',
                        body: JSON.stringify({
                            action: 'sendEmail', email: studentInfo.email, name: studentInfo.name,
                            score: results.score, quizName, date: results.date,
                            details: results.details.filter(d => !d.isCorrect).map(d => "題目：" + d.stem + "\n正確答案：" + d.answer).join('\n\n')
                        })
                    });
                    setEmailStatus('寄送成功！');
                } catch (e) { setEmailStatus('發送失敗。'); }
            };

            // --- UI 畫面 ---

            const LoginView = () => (
                <div className="flex flex-col items-center justify-center min-h-[85vh] px-4 animate-fade-in">
                    <div className="text-center mb-8">
                        <Icon name="database" size={56} className="text-amber-500 mb-4" />
                        <h1 className="text-3xl font-black text-slate-100 mb-2 tracking-tight">國文科雲端即時測驗系統</h1>
                        <p className="text-slate-500 italic text-sm">{quizName}</p>
                    </div>

                    <div className="w-full max-w-md bg-slate-900/60 p-8 rounded-[2.5rem] border border-slate-800 shadow-2xl">
                        <div className="space-y-5">
                            <IMEInput placeholder="班級 (如 101)" className="w-full bg-slate-950 border border-slate-800 rounded-xl px-5 py-3 text-slate-100 focus:border-amber-500 outline-none transition-all" value={studentInfo.class} onChange={val => setStudentInfo({...studentInfo, class: val})} />
                            <div className="grid grid-cols-2 gap-4">
                                <IMEInput placeholder="座號" className="bg-slate-950 border border-slate-800 rounded-xl px-5 py-3 text-slate-100 focus:border-amber-500 outline-none" value={studentInfo.seat} onChange={val => setStudentInfo({...studentInfo, seat: val})} />
                                <IMEInput placeholder="姓名" className="bg-slate-950 border border-slate-800 rounded-xl px-5 py-3 text-slate-100 focus:border-amber-500 outline-none" value={studentInfo.name} onChange={val => setStudentInfo({...studentInfo, name: val})} />
                            </div>
                            <button onClick={() => quizData.length > 0 ? setView('quiz') : alert('等待題庫載入中...')} className="w-full bg-amber-600 hover:bg-amber-500 text-slate-950 font-black py-4 rounded-xl mt-4 shadow-xl active:scale-95 transition-all text-lg">開始測驗</button>
                        </div>
                    </div>
                </div>
            );

            const QuizView = () => {
                const q = quizData[currentQuestionIndex];
                return (
                    <div className="max-w-2xl mx-auto py-10 px-4 animate-fade-in">
                        <div className="flex justify-between items-end mb-6">
                            <h2 className="text-xl font-bold text-amber-500">Unit: {quizName}</h2>
                            <p className="text-slate-500 font-mono text-xs uppercase tracking-widest">{currentQuestionIndex + 1} / {quizData.length}</p>
                        </div>
                        <div className="bg-slate-900 border border-slate-800 p-8 md:p-10 rounded-[2.5rem] shadow-2xl relative overflow-hidden min-h-[500px] flex flex-col justify-between">
                            <div className="absolute top-0 left-0 w-full h-1 bg-slate-800">
                                <div className="h-full bg-amber-500 transition-all duration-300" style={{width: `${((currentQuestionIndex + 1)/quizData.length)*100}%`}}></div>
                            </div>
                            
                            <div>
                                <h3 className="text-xl md:text-2xl font-bold mb-10 leading-relaxed text-slate-100 italic">「{q.stem}」</h3>
                                <div className="grid grid-cols-1 gap-4">
                                    {['A', 'B', 'C', 'D'].map(opt => (
                                        <button key={opt} onClick={() => setAnswers({...answers, [currentQuestionIndex]: opt})}
                                            className={`group p-5 rounded-2xl border text-left flex items-start gap-4 transition-all ${answers[currentQuestionIndex] === opt ? 'bg-amber-500 border-amber-500 text-slate-950 font-bold scale-[1.01]' : 'bg-slate-950 border-slate-800 text-slate-400 hover:bg-slate-800'}`}>
                                            <span className={`w-9 h-9 shrink-0 rounded-xl flex items-center justify-center font-black ${answers[currentQuestionIndex] === opt ? 'bg-slate-950 text-amber-500' : 'bg-slate-900'}`}>{opt}</span>
                                            <span className="text-lg leading-snug">{q.options ? q.options[opt] : `選取選項 ${opt}`}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>

                            <div className="flex justify-between mt-12 pt-6 border-t border-slate-800/50">
                                <button disabled={currentQuestionIndex === 0} onClick={() => setCurrentQuestionIndex(prev => prev-1)} className="flex items-center gap-1 text-slate-500 hover:text-white disabled:opacity-0 transition-all font-bold text-sm"><Icon name="chevron-left" size={16}/> Prev</button>
                                {currentQuestionIndex === quizData.length - 1 
                                    ? <button onClick={handleSubmitQuiz} className="bg-green-600 hover:bg-green-500 px-10 py-3 rounded-xl font-black text-white shadow-lg active:scale-95 transition-all text-lg">交卷結算</button>
                                    : <button onClick={() => setCurrentQuestionIndex(prev => prev+1)} className="text-amber-500 font-bold flex items-center gap-1 hover:translate-x-1 transition-transform">Next <Icon name="chevron-right" size={16}/></button>}
                            </div>
                        </div>
                    </div>
                );
            }

            const ResultsView = () => (
                <div className="max-w-4xl mx-auto py-10 px-4 animate-fade-in print-container">
                    <div className="bg-slate-900 border border-slate-800 rounded-[3rem] overflow-hidden shadow-2xl">
                        <div className="bg-amber-600 p-10 text-center no-print">
                            <h2 className="text-7xl font-black text-slate-950">{results.score}</h2>
                            <p className="text-slate-950 font-bold tracking-[0.3em] mt-2 uppercase text-xs">Points Total</p>
                        </div>
                        
                        <div className="p-8 md:p-14">
                            <div className="bg-slate-950/50 p-6 rounded-3xl border border-slate-800 mb-10 no-print">
                                <h4 className="text-amber-500 font-bold mb-4 flex items-center gap-2 tracking-wide"><Icon name="mail" size={20}/> 寄送測驗分析報告</h4>
                                <div className="flex gap-4">
                                    <IMEInput type="email" placeholder="輸入 Gmail 帳號" className="flex-1 bg-slate-900 border border-slate-800 rounded-2xl px-5 py-3 text-slate-100 outline-none" value={studentInfo.email} onChange={val => setStudentInfo({...studentInfo, email: val})} />
                                    <button onClick={sendRealEmail} className="bg-amber-600 text-slate-950 font-black px-8 py-3 rounded-2xl active:scale-95 transition-all shadow-lg">發送</button>
                                </div>
                                {emailStatus && <p className="text-xs mt-3 text-slate-500 italic">{emailStatus}</p>}
                            </div>

                            <button onClick={() => window.print()} className="w-full bg-slate-800 hover:bg-slate-700 py-4 rounded-2xl mb-12 font-bold flex items-center justify-center gap-3 no-print border border-slate-700">
                                <Icon name="download" size={20}/> 列印或儲存成果報告單
                            </button>

                            <div className="print-title hidden print:block text-center border-b-2 border-black pb-2 mb-6 uppercase tracking-widest">
                                Quiz Report: {studentInfo.name} ({results.score} Pts)
                            </div>

                            <div className="space-y-6">
                                {results.details.map((item, idx) => (
                                    <div key={idx} className={`print-card p-8 rounded-[2rem] border ${item.isCorrect ? 'border-green-500/10 bg-green-500/5' : 'border-red-500/10 bg-red-500/5'}`}>
                                        <div className="flex justify-between items-start gap-4 mb-4">
                                            <p className="print-text text-slate-100 text-xl md:text-2xl font-medium leading-relaxed">
                                                <span className="text-slate-600 font-mono mr-2 text-sm">#{idx+1}</span>{item.stem}
                                            </p>
                                        </div>
                                        <div className="flex gap-6 text-sm font-bold mb-4">
                                            <span className={item.isCorrect ? 'text-green-400' : 'text-red-400'}>學生作答：{item.studentAnswer}</span>
                                            <span className="text-green-400">正確答案：{item.answer}</span>
                                        </div>
                                        {!item.isCorrect && (
                                            <div className="print-explanation text-xl md:text-2xl text-slate-200 leading-relaxed italic border-t border-slate-800/60 pt-5 mt-5 bg-slate-950/40 p-5 rounded-2xl">
                                                <span className="text-amber-500 not-italic font-black block mb-2 uppercase tracking-widest text-xs">詳解解析 / Review</span>
                                                「{item.explanation}」
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                            <button onClick={() => window.location.reload()} className="w-full mt-16 py-8 text-slate-700 hover:text-amber-500 font-black border-t border-slate-900 pt-10 no-print text-[10px] uppercase tracking-[0.4em]">End Session</button>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen">
                    {view === 'login' && <LoginView />}
                    {view === 'quiz' && <QuizView />}
                    {view === 'results' && <ResultsView />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>