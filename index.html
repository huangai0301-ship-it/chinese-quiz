<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國文科即時測驗系統 Pro</title>
    
    <!-- 基礎環境 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #020617; 
            color: #f8fafc; 
            margin: 0; 
        }
        
        /* 極簡文字檔 PDF 列印樣式 */
        @media print {
            @page { size: A4; margin: 2cm; }
            .no-print { display: none !important; }
            body { background-color: white !important; color: black !important; }
            .print-container { background-color: white !important; padding: 0 !important; margin: 0 !important; width: 100% !important; }
            .print-card {
                border: none !important;
                border-bottom: 0.5pt solid #000 !important;
                margin-bottom: 12pt !important;
                padding: 0 0 10pt 0 !important;
                page-break-inside: avoid;
            }
            .print-header { border-bottom: 1.5pt solid black !important; margin-bottom: 20pt !important; padding-bottom: 10pt !important; }
            .print-title { font-size: 18pt !important; font-weight: bold !important; margin-bottom: 8pt !important; }
            .print-text { font-size: 11pt !important; line-height: 1.5 !important; color: black !important; }
            .print-meta { font-size: 11pt !important; margin-bottom: 5pt !important; }
            .print-explanation { 
                font-size: 10pt !important; 
                margin-top: 5pt !important;
                border-left: 2pt solid #333 !important;
                padding-left: 10pt !important;
                color: #333 !important;
            }
        }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 教師核心設定區 ---
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbybMG3mL2OgqX_i0ZeRexPy619ErLP_S9EjdLJbUw2-FjCFuJy2xqxzhPVlzuZ9wWUQdg/exec"; 
        const CLOUD_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeeTPV9EYTlaOLrCNmA6UvRJOtpshFIMHCfp11JwNwvFnAYc5v73_ytLM3MSQUsfNpxOmsfZucPeZZ/pub?output=csv"; 
        const ADMIN_PASS = "153154";
        const LOCAL_CSV_FALLBACK = "./test.csv"; 
        // --------------------

        const { useState, useEffect, useCallback, useRef } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && window.lucide.icons[name]) {
                    const svg = window.lucide.icons[name].toSvg({ width: size, height: size, class: className });
                    if (iconRef.current) iconRef.current.innerHTML = svg;
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center"></span>;
        };

        /**
         * 終極解決跳動方案：完全獨立的本地狀態輸入框
         */
        const FinalSafeInput = ({ value, onFinalChange, placeholder, className, type = "text" }) => {
            const [temp, setTemp] = useState(value || '');
            
            // 只有在外部初始載入時同步一次
            useEffect(() => {
                if (value !== temp) setTemp(value || '');
            }, [value]);

            const commit = () => {
                onFinalChange(temp);
            };

            return (
                <input 
                    type={type} 
                    value={temp} 
                    placeholder={placeholder} 
                    className={className}
                    onChange={(e) => setTemp(e.target.value)}
                    onBlur={commit}
                    onKeyDown={(e) => e.key === 'Enter' && commit()}
                    autoComplete="off"
                />
            );
        };

        const App = () => {
            const [view, setView] = useState('login');
            const [studentInfo, setStudentInfo] = useState({ class: '', seat: '', name: '', email: '' });
            const [quizData, setQuizData] = useState([]);
            const [quizName, setQuizName] = useState('載入中...');
            const [answers, setAnswers] = useState({});
            const [results, setResults] = useState(null);
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [emailStatus, setEmailStatus] = useState('');

            const processQuestionText = useCallback((rawText) => {
                // 優化正則：精準抓取並移除 (A) (B) (C) (D) 或全形版本
                const optRegex = /\s*[\(\（][A-DＡ-Ｄ][\)\）]\s*/g;
                const parts = rawText.split(optRegex);
                if (parts && parts.length >= 5) {
                    return {
                        stem: parts[0].trim(),
                        options: {
                            'A': parts[1].trim(), 'B': parts[2].trim(), 'C': parts[3].trim(), 'D': parts[4].trim()
                        },
                        isParsed: true
                    };
                }
                return { stem: rawText, options: null, isParsed: false };
            }, []);

            const parseCSV = useCallback((text) => {
                const rows = text.split(/\r?\n/).filter(line => line.trim() !== "");
                const delimiter = text.includes('\t') ? '\t' : ',';
                const data = rows.slice(1).map(row => {
                    const columns = row.split(delimiter).map(col => col.replace(/^"|"$/g, '').trim());
                    const rawQuestion = columns[0] || "";
                    const parsed = processQuestionText(rawQuestion);
                    return {
                        ...parsed,
                        answer: (columns[1] || "").toUpperCase().replace(/[ＡＢＣＤ]/g, s => String.fromCharCode(s.charCodeAt(0) - 65248)),
                        explanation: columns[2] || ""
                    };
                }).filter(item => item.stem && item.answer);
                setQuizData(data);
            }, [processQuestionText]);

            useEffect(() => {
                fetch(CLOUD_CSV_URL || LOCAL_CSV_FALLBACK)
                    .then(res => res.text())
                    .then(text => {
                        parseCSV(text);
                        setQuizName("國文科專測單元");
                    })
                    .catch(() => setQuizName("連線失敗"));
            }, [parseCSV]);

            const handleSubmitQuiz = async () => {
                const scorePerQuestion = 100 / quizData.length;
                let correctCount = 0;
                const detailResults = quizData.map((q, idx) => {
                    const studentAnswer = answers[idx] || '未答';
                    const isCorrect = studentAnswer === q.answer;
                    if (isCorrect) correctCount++;
                    return { ...q, studentAnswer, isCorrect };
                });

                const wrongIndices = detailResults.map((d, i) => d.isCorrect ? null : i + 1).filter(n => n !== null).join(', ');
                const report = {
                    score: Math.round(correctCount * scorePerQuestion),
                    date: new Date().toLocaleString('zh-TW'),
                    details: detailResults,
                    wrongQuestions: wrongIndices || "全對"
                };
                setResults(report);
                setView('results');

                // 自動傳送 GAS 記錄成績
                if (GAS_WEB_APP_URL) {
                    fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({ ...studentInfo, ...report, action: 'logScore' })
                    });
                }
            };

            const sendRealEmail = async () => {
                if (!studentInfo.email.includes('@')) return alert('Email 格式有誤');
                setEmailStatus('正在發送...');
                try {
                    await fetch(GAS_WEB_APP_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        body: JSON.stringify({
                            action: 'sendEmail',
                            email: studentInfo.email,
                            name: studentInfo.name,
                            score: results.score,
                            quizName,
                            date: results.date,
                            details: results.details.filter(d => !d.isCorrect).map((d, idx) => `題號：${results.details.indexOf(d)+1}\n題目：${d.stem}\n正確答案：${d.answer}`).join('\n\n')
                        })
                    });
                    setEmailStatus('信件已進入寄送流程，請檢查 Gmail 收件匣。');
                } catch (e) {
                    setEmailStatus('連線 GAS 伺服器失敗。');
                }
            };

            // --- Views ---

            const LoginView = () => (
                <div className="flex flex-col items-center justify-center min-h-[85vh] px-4 animate-fade-in">
                    <div className="text-center mb-10">
                        <Icon name="book" size={56} className="text-amber-500 mb-4" />
                        <h1 className="text-3xl font-black text-slate-100 mb-2">國文科雲端即時測驗</h1>
                        <p className="text-slate-500 italic text-sm">{quizName}</p>
                    </div>
                    <div className="w-full max-w-md bg-slate-900/60 p-8 rounded-[2.5rem] border border-slate-800 shadow-2xl">
                        <div className="space-y-6">
                            <FinalSafeInput placeholder="班級" className="w-full bg-slate-950 border border-slate-800 rounded-xl px-5 py-3 text-slate-100 focus:border-amber-500 outline-none" value={studentInfo.class} onFinalChange={v => setStudentInfo({...studentInfo, class: v})} />
                            <div className="grid grid-cols-2 gap-4">
                                <FinalSafeInput placeholder="座號" className="bg-slate-950 border border-slate-800 rounded-xl px-5 py-3 text-slate-100 focus:border-amber-500 outline-none" value={studentInfo.seat} onFinalChange={v => setStudentInfo({...studentInfo, seat: v})} />
                                <FinalSafeInput placeholder="姓名" className="bg-slate-950 border border-slate-800 rounded-xl px-5 py-3 text-slate-100 focus:border-amber-500 outline-none" value={studentInfo.name} onFinalChange={v => setStudentInfo({...studentInfo, name: v})} />
                            </div>
                            <button onClick={() => quizData.length > 0 ? setView('quiz') : alert('載入中...')} className="w-full bg-amber-600 text-slate-950 font-black py-4 rounded-xl mt-4 active:scale-95 transition-all text-lg">進入測驗</button>
                        </div>
                    </div>
                </div>
            );

            const QuizView = () => {
                const q = quizData[currentQuestionIndex];
                return (
                    <div className="max-w-3xl mx-auto py-10 px-4 animate-fade-in">
                        <div className="flex justify-between items-end mb-6">
                            <h2 className="text-xl font-bold text-amber-500">{quizName}</h2>
                            <p className="text-slate-500 font-mono text-xs uppercase">{currentQuestionIndex + 1} / {quizData.length}</p>
                        </div>
                        <div className="bg-slate-900 border border-slate-800 p-8 md:p-12 rounded-[2.5rem] shadow-2xl min-h-[500px] flex flex-col justify-between">
                            <div>
                                <h3 className="text-2xl md:text-3xl font-bold mb-10 leading-relaxed text-slate-100 italic">
                                    {currentQuestionIndex + 1}. 「{q.stem}」
                                </h3>
                                <div className="grid grid-cols-1 gap-4">
                                    {['A', 'B', 'C', 'D'].map(opt => (
                                        <button key={opt} onClick={() => setAnswers({...answers, [currentQuestionIndex]: opt})}
                                            className={`p-5 rounded-2xl border text-left flex items-start gap-4 transition-all ${answers[currentQuestionIndex] === opt ? 'bg-amber-500 border-amber-500 text-slate-950 font-bold' : 'bg-slate-950 border-slate-800 text-slate-400 hover:bg-slate-800'}`}>
                                            <span className={`w-9 h-9 shrink-0 rounded-xl flex items-center justify-center font-black ${answers[currentQuestionIndex] === opt ? 'bg-slate-950 text-amber-500' : 'bg-slate-900'}`}>{opt}</span>
                                            <span className="text-lg leading-snug">{q.options ? q.options[opt] : `選項 ${opt}`}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="flex justify-between mt-12 pt-6 border-t border-slate-800/50">
                                <button disabled={currentQuestionIndex === 0} onClick={() => setCurrentQuestionIndex(p => p-1)} className="text-slate-500 hover:text-white disabled:opacity-0"><Icon name="chevron-left" size={16}/> 上一題</button>
                                {currentQuestionIndex === quizData.length - 1 
                                    ? <button onClick={handleSubmitQuiz} className="bg-green-600 px-10 py-3 rounded-xl font-black text-white shadow-xl active:scale-95 transition-all text-lg">交卷</button>
                                    : <button onClick={() => setCurrentQuestionIndex(p => p+1)} className="text-amber-500 font-bold flex items-center gap-1">下一題 <Icon name="chevron-right" size={16}/></button>}
                            </div>
                        </div>
                    </div>
                );
            }

            const ResultsView = () => (
                <div className="max-w-4xl mx-auto py-10 px-4 animate-fade-in print-container">
                    <div className="bg-slate-900 border border-slate-800 rounded-[3rem] overflow-hidden shadow-2xl print:shadow-none print:border-none">
                        <div className="bg-amber-600 p-10 text-center no-print">
                            <h2 className="text-7xl font-black text-slate-950">{results.score}</h2>
                            <p className="text-slate-950 font-bold uppercase text-xs">Final Score</p>
                        </div>
                        <div className="p-10 md:p-16 print:p-0">
                            <div className="bg-slate-950/50 p-6 rounded-3xl border border-slate-800 mb-10 no-print">
                                <h4 className="text-amber-500 font-bold mb-4 flex items-center gap-2"><Icon name="mail" size={18}/> 寄送測驗分析至 Gmail</h4>
                                <div className="flex gap-3">
                                    <FinalSafeInput placeholder="您的 Gmail" className="flex-1 bg-slate-900 border border-slate-800 rounded-xl px-5 py-3 text-slate-100 outline-none" value={studentInfo.email} onFinalChange={v => setStudentInfo({...studentInfo, email: v})} />
                                    <button onClick={sendRealEmail} className="bg-amber-600 text-slate-950 font-black px-8 py-3 rounded-xl active:scale-95">發送</button>
                                </div>
                                {emailStatus && <p className="text-xs mt-3 text-slate-500 italic">{emailStatus}</p>}
                            </div>

                            <button onClick={() => window.print()} className="w-full bg-slate-800 py-3 rounded-xl mb-12 font-bold no-print border border-slate-700">
                                <Icon name="download" size={18}/> 列印或下載成果報告單 (PDF)
                            </button>

                            {/* 列印專用內容 */}
                            <div className="hidden print:block print-header">
                                <div className="print-title">國文測驗成果分析報告</div>
                                <div className="print-meta">
                                    姓名：{studentInfo.name} ({studentInfo.class}班 {studentInfo.seat}號)<br />
                                    測驗：{quizName} | 日期：{results.date}<br />
                                    總分：{results.score} 分
                                </div>
                            </div>

                            <div className="space-y-6">
                                {results.details.map((item, idx) => (
                                    <div key={idx} className="print-card p-6 border border-slate-800 print:border-none print:p-0">
                                        <p className="print-text text-slate-100 text-xl md:text-2xl font-bold leading-relaxed mb-4">
                                            Q{idx+1}. {item.stem}
                                        </p>
                                        <div className="print-text flex gap-6 text-sm font-bold print:font-bold">
                                            <span className={item.isCorrect ? 'text-green-400' : 'text-red-400'}>作答：[{item.studentAnswer}]</span>
                                            <span className="text-green-400">正確：[{item.answer}]</span>
                                        </div>
                                        {!item.isCorrect && (
                                            <div className="print-explanation text-xl md:text-2xl text-slate-300 italic mt-4 bg-slate-950/40 p-4 rounded-xl print:text-black">
                                                <span className="text-amber-500 font-bold block mb-1 uppercase text-xs print:text-black">解析說明：</span>
                                                {item.explanation}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                            <button onClick={() => window.location.reload()} className="w-full mt-10 py-6 text-slate-700 border-t border-slate-900 no-print uppercase font-black text-xs">End Session</button>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen">
                    {view === 'login' && <LoginView />}
                    {view === 'quiz' && <QuizView />}
                    {view === 'results' && <ResultsView />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>