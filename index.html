<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國文科即時測驗系統 Pro</title>
    
    <!-- 基礎環境 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #020617; 
            color: #f8fafc; 
            margin: 0; 
            overflow-x: hidden;
        }
        
        /* PDF 列印樣式 (基礎文字檔模式) */
        @media print {
            @page { size: A4; margin: 1.5cm; }
            .no-print { display: none !important; }
            body { background-color: white !important; color: black !important; }
            .print-container { background-color: white !important; padding: 0 !important; margin: 0 !important; width: 100% !important; }
            .print-card { border: none !important; border-bottom: 0.5pt solid #000 !important; margin-bottom: 10pt !important; padding: 0 0 8pt 0 !important; page-break-inside: avoid; }
            .print-header { border-bottom: 1.5pt solid black !important; margin-bottom: 15pt !important; padding-bottom: 8pt !important; }
            .print-title { font-size: 16pt !important; font-weight: bold !important; margin-bottom: 5pt !important; color: black !important; }
            .print-text { font-size: 11pt !important; line-height: 1.4 !important; color: black !important; }
            .print-meta { font-size: 10pt !important; margin-bottom: 3pt !important; color: black !important; }
            .print-option { font-size: 10pt !important; margin-left: 12pt !important; line-height: 1.2 !important; color: #333 !important; }
            .print-explanation { font-size: 10pt !important; margin-top: 5pt !important; border-left: 2pt solid #666 !important; padding-left: 10pt !important; color: #444 !important; font-style: italic !important; }
        }
        
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 教師核心設定區 ---
        const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwUXMGkwZlARC1awxbvm2fHi6WxZ-fEsXGcYCzuMLvmeeBy9mjc7Z29VhrPhajfyFJzcw/exec"; 
        const CLOUD_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQeeTPV9EYTlaOLrCNmA6UvRJOtpshFIMHCfp11JwNwvFnAYc5v73_ytLM3MSQUsfNpxOmsfZucPeZZ/pub?output=csv"; 
        const LOCAL_CSV_FALLBACK = "./test.csv"; 
        // --------------------

        const { useState, useEffect, useCallback, useRef } = React;

        const Icon = ({ name, size = 24, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && window.lucide.icons[name]) {
                    const svg = window.lucide.icons[name].toSvg({ width: size, height: size, class: className });
                    if (iconRef.current) iconRef.current.innerHTML = svg;
                }
            }, [name, size, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center"></span>;
        };

        const FinalSafeInput = ({ value, onFinalChange, placeholder, className, type = "text" }) => {
            const [temp, setTemp] = useState(value || '');
            useEffect(() => { if (value !== temp) setTemp(value || ''); }, [value]);
            const commit = () => { if (temp !== value) onFinalChange(temp); };
            return (
                <input type={type} value={temp} placeholder={placeholder} className={className}
                    onChange={(e) => setTemp(e.target.value)} onBlur={commit} onKeyDown={(e) => e.key === 'Enter' && commit()} autoComplete="off" />
            );
        };

        const App = () => {
            const [view, setView] = useState('login');
            const [studentInfo, setStudentInfo] = useState({ class: '', seat: '', name: '', email: '' });
            const [quizData, setQuizData] = useState([]);
            const [quizStatus, setQuizStatus] = useState('loading'); // loading, ready, error
            const [quizName, setQuizName] = useState('資料載入中...');
            const [answers, setAnswers] = useState({});
            const [results, setResults] = useState(null);
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [emailStatus, setEmailStatus] = useState('');

            // 解析題目與選項
            const processQuestionText = useCallback((rawText) => {
                const optRegex = /\s*[\(\（][A-DＡ-Ｄ][\)\）]\s*/g;
                const parts = rawText.split(optRegex);
                if (parts && parts.length >= 5) {
                    return {
                        stem: parts[0].trim(),
                        options: { 'A': parts[1].trim(), 'B': parts[2].trim(), 'C': parts[3].trim(), 'D': parts[4].trim() },
                        isParsed: true
                    };
                }
                return { stem: rawText, options: null, isParsed: false };
            }, []);

            const loadQuiz = useCallback(async () => {
                setQuizStatus('loading');
                setQuizName('正在連線雲端題庫...');
                try {
                    const res = await fetch(CLOUD_CSV_URL + "&t=" + new Date().getTime()); // 加入隨機參數防止快取
                    if (!res.ok) throw new Error("網路請求失敗");
                    const text = await res.text();
                    
                    const rows = text.split(/\r?\n/).filter(line => line.trim() !== "");
                    if (rows.length < 2) throw new Error("CSV 檔案內容不足(只有標題或空白)");

                    const delimiter = text.includes('\t') ? '\t' : ',';
                    const data = rows.slice(1).map(row => {
                        const columns = row.split(delimiter).map(col => col.replace(/^"|"$/g, '').trim());
                        const parsed = processQuestionText(columns[0] || "");
                        return {
                            ...parsed,
                            answer: (columns[1] || "").toUpperCase().replace(/[ＡＢＣＤ]/g, s => String.fromCharCode(s.charCodeAt(0) - 65248)),
                            explanation: columns[2] || ""
                        };
                    }).filter(item => item.stem && item.answer);

                    if (data.length === 0) throw new Error("無法解析出有效的題目內容");

                    setQuizData(data);
                    setQuizName("國文科專題測驗單元");
                    setQuizStatus('ready');
                } catch (err) {
                    console.error(err);
                    setQuizName("載入失敗：" + err.message);
                    setQuizStatus('error');
                }
            }, [processQuestionText]);

            useEffect(() => {
                loadQuiz();
            }, [loadQuiz]);

            const handleSubmitQuiz = () => {
                const scorePerQuestion = 100 / quizData.length;
                let correctCount = 0;
                const detailResults = quizData.map((q, idx) => {
                    const studentAnswer = answers[idx] || '未答';
                    const isCorrect = studentAnswer === q.answer;
                    if (isCorrect) correctCount++;
                    return { ...q, studentAnswer, isCorrect };
                });

                const report = {
                    score: Math.round(correctCount * scorePerQuestion),
                    date: new Date().toLocaleString('zh-TW'),
                    details: detailResults,
                    wrongQuestions: detailResults.map((d, i) => d.isCorrect ? null : i + 1).filter(n => n !== null).join(', ') || "全對"
                };
                
                setResults(report);
                setView('results');

                fetch(GAS_WEB_APP_URL, {
                    method: 'POST', mode: 'no-cors',
                    body: JSON.stringify({ ...studentInfo, ...report, action: 'logScore' })
                });
            };

            const sendRealEmail = async () => {
                if (!studentInfo.email.includes('@')) return alert('Email 格式錯誤');
                setEmailStatus('正在發送...');
                try {
                    await fetch(GAS_WEB_APP_URL, {
                        method: 'POST', mode: 'no-cors',
                        body: JSON.stringify({
                            action: 'sendEmail', email: studentInfo.email, name: studentInfo.name,
                            score: results.score, quizName, date: results.date,
                            details: results.details.filter(d => !d.isCorrect).map((d) => {
                                const idx = results.details.indexOf(d) + 1;
                                let optText = d.options ? `\n(A)${d.options.A}\n(B)${d.options.B}\n(C)${d.options.C}\n(D)${d.options.D}` : "";
                                return `【第${idx}題】\n題目：${d.stem}${optText}\n您的作答：${d.studentAnswer}\n正確答案：${d.answer}\n解析：${d.explanation}`;
                            }).join('\n\n')
                        })
                    });
                    setEmailStatus('發信指令已送出！請檢查 Gmail。');
                } catch (e) { setEmailStatus('發送失敗。'); }
            };

            // --- 視圖組件 ---

            const LoginView = () => (
                <div className="flex flex-col items-center justify-center min-h-[85vh] px-4 animate-fade-in">
                    <div className="text-center mb-10">
                        <Icon name="book-open" size={56} className="text-amber-500 mb-4" />
                        <h1 className="text-3xl font-black text-slate-100 mb-2">國文科雲端即時測驗系統</h1>
                        <p className={`text-sm italic ${quizStatus === 'error' ? 'text-red-400 font-bold' : 'text-slate-500'}`}>{quizName}</p>
                        {quizStatus === 'error' && (
                            <button onClick={loadQuiz} className="mt-4 text-xs bg-slate-800 px-4 py-2 rounded-full border border-slate-700 hover:bg-slate-700">點此重試載入題庫</button>
                        )}
                    </div>
                    <div className="w-full max-w-md bg-slate-900/60 p-8 rounded-[2rem] border border-slate-800 shadow-2xl">
                        <div className="space-y-6">
                            <FinalSafeInput placeholder="班級 (例如 101)" className="w-full bg-slate-950 border border-slate-800 rounded-xl px-5 py-3 text-slate-100 focus:border-amber-500 outline-none" value={studentInfo.class} onFinalChange={v => setStudentInfo(p => ({...p, class: v}))} />
                            <div className="grid grid-cols-2 gap-4">
                                <FinalSafeInput placeholder="座號" className="bg-slate-950 border border-slate-800 rounded-xl px-5 py-3 text-slate-100 focus:border-amber-500 outline-none" value={studentInfo.seat} onFinalChange={v => setStudentInfo(p => ({...p, seat: v}))} />
                                <FinalSafeInput placeholder="姓名" className="bg-slate-950 border border-slate-800 rounded-xl px-5 py-3 text-slate-100 focus:border-amber-500 outline-none" value={studentInfo.name} onFinalChange={v => setStudentInfo(p => ({...p, name: v}))} />
                            </div>
                            <button 
                                onClick={() => quizStatus === 'ready' ? setView('quiz') : alert('題庫尚未載入成功')} 
                                className={`w-full font-black py-4.5 rounded-2xl mt-4 transition-all text-lg ${quizStatus === 'ready' ? 'bg-amber-600 text-slate-950 shadow-xl' : 'bg-slate-800 text-slate-500 cursor-not-allowed'}`}
                            >
                                {quizStatus === 'loading' ? '正在同步雲端資料...' : '進入測驗'}
                            </button>
                        </div>
                    </div>
                </div>
            );

            const QuizView = () => {
                const q = quizData[currentQuestionIndex];
                return (
                    <div className="max-w-3xl mx-auto py-10 px-4 animate-fade-in">
                        <div className="flex justify-between items-end mb-8 px-2">
                            <h2 className="text-xl font-bold text-amber-500">{quizName}</h2>
                            <p className="text-slate-500 font-mono text-sm uppercase">{currentQuestionIndex + 1} / {quizData.length}</p>
                        </div>
                        <div className="bg-slate-900 border border-slate-800 p-8 md:p-14 rounded-[3rem] shadow-2xl min-h-[550px] flex flex-col justify-between relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-1 bg-slate-800">
                                <div className="h-full bg-amber-500 transition-all duration-300 shadow-[0_0_10px_#f59e0b]" style={{width: `${((currentQuestionIndex + 1)/quizData.length)*100}%`}}></div>
                            </div>
                            <div>
                                <h3 className="text-2xl md:text-3xl font-bold mb-12 leading-relaxed text-slate-100 italic">{currentQuestionIndex + 1}. 「{q.stem}」</h3>
                                <div className="grid grid-cols-1 gap-5">
                                    {['A', 'B', 'C', 'D'].map(opt => (
                                        <button key={opt} onClick={() => setAnswers({...answers, [currentQuestionIndex]: opt})}
                                            className={`group p-6 rounded-2xl border text-left flex items-start gap-5 transition-all ${answers[currentQuestionIndex] === opt ? 'bg-amber-500 border-amber-500 text-slate-950 font-black scale-[1.01]' : 'bg-slate-950 border-slate-800 text-slate-400 hover:bg-slate-800'}`}>
                                            <span className={`w-10 h-10 shrink-0 rounded-xl flex items-center justify-center font-black ${answers[currentQuestionIndex] === opt ? 'bg-slate-950 text-amber-500' : 'bg-slate-900'}`}>{opt}</span>
                                            <span className="text-xl leading-snug">{q.options ? q.options[opt] : `選項內容 ${opt}`}</span>
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="flex justify-between mt-16 pt-8 border-t border-slate-800/50">
                                <button disabled={currentQuestionIndex === 0} onClick={() => setCurrentQuestionIndex(p => p-1)} className="text-slate-500 hover:text-white disabled:opacity-0 transition-all font-bold"><Icon name="chevron-left" size={18}/> 上一題</button>
                                {currentQuestionIndex === quizData.length - 1 
                                    ? <button onClick={handleSubmitQuiz} className="bg-green-600 px-12 py-3 rounded-xl font-black text-white shadow-xl active:scale-95 transition-all text-lg">完成交卷</button>
                                    : <button onClick={() => setCurrentQuestionIndex(p => p+1)} className="text-amber-500 font-bold flex items-center gap-1 hover:translate-x-1 transition-transform">下一題 <Icon name="chevron-right" size={18}/></button>}
                            </div>
                        </div>
                    </div>
                );
            }

            const ResultsView = () => (
                <div className="max-w-4xl mx-auto py-10 px-4 animate-fade-in print-container">
                    <div className="bg-slate-900 border border-slate-800 rounded-[3rem] overflow-hidden shadow-2xl print:shadow-none print:border-none">
                        <div className="bg-amber-600 p-10 text-center no-print">
                            <h2 className="text-7xl font-black text-slate-950">{results.score}</h2>
                            <p className="text-slate-900 font-black uppercase text-xs tracking-widest">Final Score</p>
                        </div>
                        <div className="p-8 md:p-14 print:p-0">
                            <div className="bg-slate-950/50 p-8 rounded-2xl border border-slate-800 mb-10 no-print">
                                <h4 className="text-amber-500 font-black mb-5 flex items-center gap-2"><Icon name="mail" size={20}/> 寄送正式分析報告至 Gmail</h4>
                                <div className="flex gap-3">
                                    <FinalSafeInput placeholder="您的 Gmail" className="flex-1 bg-slate-900 border border-slate-800 rounded-xl px-5 py-4 text-slate-100 outline-none focus:border-amber-500" value={studentInfo.email} onFinalChange={v => setStudentInfo(p => ({...p, email: v}))} />
                                    <button onClick={sendRealEmail} className="bg-amber-600 text-slate-950 font-black px-10 py-4 rounded-xl active:scale-95">發送</button>
                                </div>
                                {emailStatus && <p className="text-xs mt-3 text-slate-500 italic flex items-center gap-1"><Icon name="alert-circle" size={14}/> {emailStatus}</p>}
                            </div>

                            <button onClick={() => window.print()} className="w-full bg-slate-800 hover:bg-slate-700 py-4 rounded-2xl mb-12 font-bold no-print border border-slate-700 flex items-center justify-center gap-2">
                                <Icon name="download" size={20}/> 下載或列印精簡成果單 (PDF)
                            </button>

                            <div className="hidden print:block print-header">
                                <div className="print-title">國文科測驗成果分析報告</div>
                                <div className="print-meta">姓名：{studentInfo.name} ({studentInfo.class}班 {studentInfo.seat}號) | 得分：{results.score} 分 | 日期：{results.date}</div>
                            </div>

                            <div className="space-y-10">
                                {results.details.map((item, idx) => (
                                    <div key={idx} className="print-card p-6 border border-slate-800 print:border-none print:p-0">
                                        <p className="print-text text-slate-100 text-xl md:text-2xl font-bold leading-relaxed mb-6">Q{idx+1}. {item.stem}</p>
                                        
                                        <div className="space-y-3 mb-6">
                                            {item.options && ['A','B','C','D'].map(o => (
                                                <div key={o} className={`text-sm md:text-base print-option ${
                                                    (item.studentAnswer === o) ? 'text-amber-400 font-bold print-selection-marker' : 'text-slate-400'
                                                }`}>
                                                    ({o}) {item.options[o]}
                                                    {(item.studentAnswer === o) && <span className="ml-2 no-print text-[10px] bg-slate-800 px-2 py-0.5 rounded text-slate-100">學生選擇</span>}
                                                    {(item.answer === o) && <span className="ml-2 no-print text-[10px] bg-green-900/50 px-2 py-0.5 rounded text-green-400">正確解答</span>}
                                                </div>
                                            ))}
                                        </div>

                                        <div className="print-text flex gap-8 text-sm font-bold border-t border-slate-800/50 pt-4 print:border-none">
                                            <span className={item.isCorrect ? 'text-green-400' : 'text-red-400'}>作答：[{item.studentAnswer}]</span>
                                            <span className="text-green-400">正確：[{item.answer}]</span>
                                        </div>
                                        {!item.isCorrect && (
                                            <div className="print-explanation text-lg md:text-xl text-slate-300 italic mt-5 bg-slate-950/40 p-5 rounded-2xl print:text-black print:bg-none print:p-2 border-l-4 border-amber-600">
                                                <span className="text-amber-500 font-bold block mb-1 uppercase text-xs print:text-black">解析說明：</span>{item.explanation}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                            <button onClick={() => window.location.reload()} className="w-full mt-20 py-10 text-slate-700 hover:text-amber-500 border-t border-slate-900 no-print uppercase font-black text-xs tracking-widest">End Session</button>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen">
                    {view === 'login' && <LoginView />}
                    {view === 'quiz' && <QuizView />}
                    {view === 'results' && <ResultsView />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>